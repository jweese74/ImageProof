{% extends 'base.html' %}
<!-- Image detail template. For PHP, replace Jinja2 tags with <?php ?> equivalents -->

{% block title %}Image Detail - ImageProof{% endblock %}

{# Optional global CSRF token block #}
{% block csrf_token %}
    {{ csrf_token() }}
{% endblock %}

{% block content %}
<section class="image-detail section">
    <header>
        <h1>{{ image.title | e }}</h1>
        <span class="status {{ image.status | lower }}">{{ image.status }}</span>
    </header>

    {# Warning banner for flagged or revoked images #}
    {% if image.status in ['Flagged', 'Revoked'] %}
    <div class="alert error" role="alert">
        This image has been {{ image.status | lower }}.
    </div>
    {% endif %}

    {# Limited view for unauthenticated/unauthorized users #}
    {% if not authorized %}
    <p class="text-muted">This image is registered but full details require login.</p>
    {% endif %}

    <article class="card">
        <div class="preview">
            <picture>
                <source srcset="{{ image.preview_url }}" type="image/webp">
                <img src="{{ image.preview_url }}" alt="Watermarked preview of {{ image.title }}" class="watermark-preview" loading="lazy">
            </picture>
        </div>

        <div class="metadata">
            <div class="metadata-row"><strong>Creator:</strong> {{ image.creator_name | e }}</div>
            <div class="metadata-row"><strong>Date Registered:</strong> {{ image.registered_at.strftime('%Y-%m-%d') }}</div>
            <div class="metadata-row hash-block"><strong>SHA-256:</strong> {{ image.sha256 }}</div>
            <div class="metadata-row hash-block"><strong>pHash:</strong> {{ image.phash }}</div>
            <div class="metadata-row"><strong>License Type:</strong> {{ image.license_type | e }}</div>
        </div>

        {% if image.qr_url %}
        <aside class="qr-preview">
            <img src="{{ image.qr_url }}" alt="QR code for {{ image.title }}">
        </aside>
        {% endif %}
    </article>

    <div class="actions">
        <a href="{{ url_for('member.download_certificate', image_id=image.id) }}" class="btn">Download Certificate</a>
        <a href="{{ url_for('member.download_zip', image_id=image.id) }}" class="btn">ZIP Package</a>

        {% if authorized %}
        <a href="{{ url_for('member.edit_image', image_id=image.id) }}" class="btn">Edit Metadata</a>
        <a href="{{ url_for('member.transfer_image', image_id=image.id) }}" class="btn">Transfer Ownership</a>
        <form method="post" action="{{ url_for('member.delete_image', image_id=image.id) }}" onsubmit="return confirm('Delete this image?');" style="display:inline">
            {{ csrf_token() }}
            <button type="submit" class="btn">Delete Image</button>
        </form>
        <form method="post" action="{{ url_for('member.flag_image', image_id=image.id) }}" style="display:inline">
            {{ csrf_token() }}
            <button type="submit" class="btn">Flag Image</button>
        </form>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %}